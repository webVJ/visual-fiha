author: ''
title: ''
clock:
  bpm: 120
audio:
  stream: ''
signals: {}
mappings:
  knob1:
    targets:
      - layers.canvas.parameters.knobA.value
    transformFunction: return val;
    source: 'midi:nk2.knob1'
  knob2:
    targets:
      - layers.canvas.parameters.knobB.value
    transformFunction: return val;
    source: 'midi:nk2.knob2'
  knob3:
    targets:
      - layers.canvas.parameters.knobC.value
    transformFunction: return val;
    source: 'midi:nk2.knob3'
  slider1:
    targets:
      - layers.canvas.parameters.sliderA.value
    transformFunction: return val;
    source: 'midi:nk2.slider1'
  slider2:
    targets:
      - layers.canvas.parameters.sliderB.value
    transformFunction: return val;
    source: 'midi:nk2.slider2'
  slider3:
    targets:
      - layers.canvas.parameters.sliderC.value
    transformFunction: return val;
    source: 'midi:nk2.slider3'
  constSrcFront:
    targets:
      - layers.constFront.parameters.src.value
      - layers.constMid.parameters.src.value
    transformFunction: |-
      var c = 3;
      var t = 2;
      var i = Math.floor((val % (c * t)) / t) + 1;
      return './assets/construction-work/'+ i +'/front.png';
    source: clock.beatnum
  constSrcBack:
    targets:
      - layers.constBack.parameters.src.value
    transformFunction: |-
      var c = 3;
      var t = 2;
      var i = Math.floor((val % (c * t)) / t) + 1;
      return './assets/construction-work/'+ i +'/back.png';
    source: clock.beatnum
  treeSrcFront:
    targets:
      - layers.treeMid.parameters.src.value
      - layers.treeFront.parameters.src.value
    transformFunction: |-
      var c = 3;
      var t = 2;
      var i = Math.floor((val % (c * t)) / t) + 1;
      return './assets/trees/'+ i +'/front.png';
    source: clock.beatnum
  treeSrcBack:
    targets:
      - layers.treeBack.parameters.src.value
    transformFunction: |-
      var c = 3;
      var t = 2;
      var i = Math.floor((val % (c * t)) / t) + 1;
      return './assets/trees/'+ i +'/back.png';
    source: clock.beatnum
  toggleConsruction:
    targets:
      - layers.constBack.parameters.active.value
      - layers.treeBack.parameters.active.value
      - layers.constFront.parameters.active.value
    transformFunction: 'return val ? !prev : prev;'
    source: 'midi:nk2.r1'
  toggleTree:
    targets:
      - layers.constMid.parameters.active.value
      - layers.treeMid.parameters.active.value
      - layers.treeFront.parameters.active.value
    transformFunction: 'return val ? !prev : prev;'
    source: 'midi:nk2.r1'
  cwRotation:
    targets:
      - layers.constMid.parameters.rotation.value
      - layers.treeMid.parameters.rotation.value
    transformFunction: return ((360 / -127) * val) + 'deg';
    source: 'midi:nk2.slider8'
  ccwRotation:
    targets:
      - layers.treeFront.parameters.rotation.value
      - layers.constFront.parameters.rotation.value
    transformFunction: return ((360 / 127) * val) + 'deg';
    source: 'midi:nk2.slider7'
layers:
  constBack:
    type: img
    layerStyles: |-
      filter: saturate(0%);
      transform: scale(calc(1 + ((100 - var(--beatprct)) * 0.005)));
    parameters:
      - name: active
        type: boolean
        value: true
        default: true
      - name: src
        type: string
        value: ./assets/construction-work/3/back.png
        default: ''
      - name: zIndex
        type: number
        value: 0
        default: 0
  treeBack:
    type: img
    layerStyles: |-
      filter: saturate(0%);
      transform: scale(calc(1 + ((100 - var(--beatprct)) * 0.005)));
    parameters:
      - name: active
        type: boolean
        value: false
        default: false
      - name: src
        type: string
        value: ./assets/trees/3/back.png
        default: ''
      - name: zIndex
        type: number
        value: 0
        default: 0
  constMid:
    type: img
    layerStyles: |-
      filter: saturate(0%);
      transform: scale(calc(1 + ((100 - var(--beatprct)) * 0.005)))
                  rotateZ(var(--rotation));
    parameters:
      - name: active
        type: boolean
        value: true
        default: true
      - name: rotation
        type: any
        value: '-294.8031496062992deg'
        default: '0'
      - name: src
        type: string
        value: ./assets/construction-work/3/front.png
        default: ''
      - name: zIndex
        type: number
        value: 0
        default: 0
  treeMid:
    type: img
    layerStyles: |-
      filter: saturate(0%);
      transform: scale(calc(1 + ((100 - var(--beatprct)) * 0.005)))
                  rotateZ(var(--rotation));
    parameters:
      - name: active
        type: boolean
        value: false
        default: false
      - name: rotation
        type: any
        value: '-294.8031496062992deg'
        default: '0'
      - name: src
        type: string
        value: ./assets/trees/3/front.png
        default: ''
      - name: zIndex
        type: number
        value: 0
        default: 0
  canvas:
    type: canvas
    layerStyles: 'mix-blend-mode: multiply;'
    updateFunction: >
      ctx.clearRect(0, 0, width, height);

      var mf = 1 / 127;

      var kA = param('knobA', 63);

      var kB = param('knobB', 63);

      var kC = param('knobC', 63);

      var sA = param('sliderA', 63);

      var sB = param('sliderB', 63);

      var sC = param('sliderC', 63);

      var count = Math.pow((beatnum % 4) + 2, 2);

      var rows = Math.sqrt(count);

      var baseSize = sA + 1;

      var sides = rows + 2;//utils.between(Math.round(sB * (1 / (127 /
      9))),3,9);

      var baseLineWidth = utils.between(sC * (1 / (127 / 16)),1,16);


      var col = 'hsl('+Math.round(kA * mf * 360)+','+Math.round(kB * mf *
      100)+'%,'+Math.round((vol(16) / 255) * 100)+'%)';

      /*

      var i = 0;

      grid(count, rows, function (x, y) {
        ctx.lineWidth = (frq(i) * 0.025 * vmin * baseLineWidth);
        ctx.strokeStyle = col;
        polygone(x, y, vmin * baseSize, sides);
        i++;
      });

      */


      var tau = Math.PI * 2;

      ctx.lineWidth = vmin * 0.5;

      var v = (360 / 255) * vol();


      var baseX = width / 2;

      var baseY = height / 2;

      var groupCount = sides + 1;//7;

      var circleCount = 15;


      repeat(groupCount, function(groupNum) {
        var a = (tau / (groupCount -1)) * groupNum;
        var xTilt = groupNum ? Math.sin(a) * (vmin * 25) : 0;
        var yTilt = groupNum ? Math.cos(a) * (vmin * 25) : 0;

        repeat(circleCount, function(circleNum) {
          // var f = Math.round((360 / circleCount) * circleNum);
          ctx.strokeStyle = 'hsl('+v+', 100%, 50%)';
          polygone(baseX + xTilt, baseY + yTilt, vmin * circleNum, sides);
          // ctx.beginPath();
          // ctx.arc(baseX + xTilt, baseY + yTilt, vmin * circleNum, 0, tau);
          // ctx.stroke();
        });

      });
    parameters:
      - name: active
        type: boolean
        value: true
        default: true
      - name: clear
        type: number
        value: 1
        default: 1
      - name: knobA
        type: number
        value: 70
        default: 63
      - name: knobB
        type: number
        value: 103
        default: 63
      - name: knobC
        type: number
        value: 63
        default: 63
      - name: sliderA
        type: number
        value: 47
        default: 63
      - name: sliderB
        type: number
        value: 56
        default: 63
      - name: sliderC
        type: number
        value: 54
        default: 63
      - name: zIndex
        type: number
        value: 0
        default: 0
  constFront:
    type: img
    layerStyles: |-
      filter: saturate(0%);
      transform: scale(calc(1 + ((100 - var(--beatprct)) * 0.005)))
                  rotateZ(var(--rotation));
    parameters:
      - name: active
        type: boolean
        value: true
        default: true
      - name: rotation
        type: any
        value: 192.75590551181102deg
        default: '0'
      - name: src
        type: string
        value: ./assets/construction-work/3/front.png
        default: ''
      - name: zIndex
        type: number
        value: 0
        default: 0
  treeFront:
    type: img
    layerStyles: |-
      filter: saturate(0%);
      transform: scale(calc(1 + ((100 - var(--beatprct)) * 0.005)))
                  rotateZ(var(--rotation));
    parameters:
      - name: active
        type: boolean
        value: false
        default: false
      - name: rotation
        type: any
        value: 192.75590551181102deg
        default: '0'
      - name: src
        type: string
        value: ./assets/trees/3/front.png
        default: ''
      - name: zIndex
        type: number
        value: 0
        default: 0
  plot:
    type: canvas
    layerStyles: ''
    updateFunction: |-
      ctx.clearRect(0, 0, width, height);
      var _heap = usedHeap / (1024 * 1024);
      var _fps = ((fps - 60) / 30);
      var _bang = vol() > (255 *(3 / 2)) ? 1 : 0;
      plotPush('fps', _fps, width);
      plotPush('bang', _bang, width);

      plot([
        ['fps', 'white'],
        ['bang', 'red']
      ]);

      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillStyle = 'black';
      ctx.strokeStyle = 'white';
      ctx.font = '20px monospace';
      writeThings([
        _heap.toFixed(2),
        fps.toFixed(),
        _fps.toFixed(),
        _bang.toFixed(),
      ]);
    parameters:
      - name: active
        type: boolean
        value: true
        default: true
      - name: clear
        type: number
        value: 1
        default: 1
      - name: zIndex
        type: number
        value: 0
        default: 0
